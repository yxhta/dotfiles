#!/usr/bin/env zsh
# ============================================================================
# Claude Code Session Selector
# ============================================================================
# List Claude Code sessions running in tmux and jump to one
# Dependencies: tmux, fzf
# Usage: ccs

ccs() {
  if ! command -v tmux &> /dev/null; then
    echo "Error: tmux is not installed" >&2
    return 1
  fi
  if ! command -v fzf &> /dev/null; then
    echo "Error: fzf is not installed" >&2
    return 1
  fi
  if ! tmux info &> /dev/null 2>&1; then
    echo "Error: tmux server is not running" >&2
    return 1
  fi

  local pane_list=""
  local pane_data
  pane_data=$(tmux list-panes -a \
    -F '#{session_name}:#{window_index}.#{pane_index}	#{pane_pid}	#{pane_current_path}	#{window_name}')

  while IFS=$'\t' read -r target pid cwd wname; do
    if pgrep -P "$pid" -x claude &> /dev/null; then
      local short_cwd="${cwd/#$HOME/~}"
      pane_list+="${target}	${short_cwd}	${wname}"$'\n'
    fi
  done <<< "$pane_data"

  if [[ -z "$pane_list" ]]; then
    echo "No Claude Code sessions found in tmux" >&2
    return 1
  fi

  local selection
  selection=$(echo -n "$pane_list" | column -t -s $'\t' | fzf \
    --prompt="Claude session: " \
    --header="PANE            DIRECTORY                   WINDOW" \
    --no-multi \
    --height=40% \
    --reverse)

  [[ -z "$selection" ]] && return 0

  local target_pane
  target_pane=$(echo "$selection" | awk '{print $1}')

  if [[ -n "$TMUX" ]]; then
    tmux switch-client -t "${target_pane%.*}"
    tmux select-pane -t "$target_pane"
  else
    tmux attach-session -t "${target_pane%%:*}"
  fi
}
