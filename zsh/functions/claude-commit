# Interactive commit with confirmation
function claude_commit_interactive() {
  local stage_all=0
  local amend=0
  local no_verify=0
  local show_diff=0
  local use_editor=0
  local diff_output
  local commit_msg

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -a|--all) stage_all=1 ;;
      --amend) amend=1 ;;
      --no-verify) no_verify=1 ;;
      -d|--diff) show_diff=1 ;;
      -e|--edit) use_editor=1 ;;
      -h|--help)
        echo "Usage: ccmi [-a|--all] [--amend] [--no-verify] [-d|--diff] [-e|--edit]"
        return 0
        ;;
      *)
        echo "Error: Unknown option: $1"
        return 1
        ;;
    esac
    shift
  done

  if [[ $stage_all -eq 1 ]]; then
    git add -A
  fi

  diff_output=$(git diff --staged)
  if [[ -z "$diff_output" ]]; then
    echo "Error: No staged changes found"
    echo "Tip: run 'git add -A' or use ccmi --all"
    return 1
  fi

  if [[ $show_diff -eq 1 ]]; then
    git diff --staged | ${PAGER:-less}
  fi

  echo "Analyzing staged changes..."
  commit_msg=$(echo "$diff_output" | claude -p "You are a git commit message generator. Analyze the provided git diff and generate a single-line Conventional Commits compliant commit message.

CRITICAL REQUIREMENTS:
1. Output ONLY the commit message text - no explanations, no markdown, no quotes, no additional commentary
2. Format: <type>[optional scope]: <description>
3. The entire output must be a valid git commit message that can be used directly with 'git commit -m'

TYPE SELECTION (choose ONE):
- feat: new features or functionality
- fix: bug fixes
- docs: documentation changes only
- style: formatting, whitespace, no code logic changes
- refactor: code restructuring without changing behavior
- perf: performance improvements
- test: adding or modifying tests
- build: build system, dependencies (package.json, Cargo.toml, etc)
- ci: CI/CD configuration (GitHub Actions, CircleCI, etc)
- chore: maintenance tasks, tooling, configs

FORMATTING RULES:
- Description: imperative mood (\"add\" not \"added\"), lowercase, no period at end
- Length: keep total message under 72 characters
- Scope: add if changes focus on specific component (e.g., \"api\", \"ui\", \"auth\")
- Examples:
  * feat(auth): add JWT token validation
  * fix: resolve memory leak in worker threads
  * docs: update installation guide
  * refactor(parser): simplify token handling logic

IMPORTANT: Your entire response must be the commit message only. Any extra text will break the script." --model opus --max-turns 3 --strict-mcp-config)
  if [[ -z "$commit_msg" ]]; then
    echo "Error: Failed to generate commit message"
    return 1
  fi

  while true; do
    echo
    echo "Proposed commit message:"
    echo "  $commit_msg"
    echo
    echo -n "Commit? [Y]es / [e]dit / [r]egen / [s]how diff / [q]uit: "
    read REPLY

    if [[ -z "$REPLY" || "$REPLY" =~ ^[Yy]$ ]]; then
      local commit_args=()
      if [[ $amend -eq 1 ]]; then
        commit_args+=(--amend)
      fi
      if [[ $no_verify -eq 1 ]]; then
        commit_args+=(--no-verify)
      fi
      if [[ $use_editor -eq 1 ]]; then
        commit_args+=(--edit)
      fi
      git commit "${commit_args[@]}" -m "$commit_msg"
      echo "✅ Commit completed successfully"
      return 0
    fi

    case "$REPLY" in
      [Ee])
        local tmpfile
        tmpfile=$(mktemp -t ccmi-msg.XXXXXX)
        printf "%s\n" "$commit_msg" > "$tmpfile"
        ${EDITOR:-vi} "$tmpfile"
        if [[ -s "$tmpfile" ]]; then
          commit_msg=$(cat "$tmpfile")
        else
          echo "Edit cancelled; keeping previous message."
        fi
        rm -f "$tmpfile"
        ;;
      [Rr])
        echo "Re-generating commit message..."
        commit_msg=$(echo "$diff_output" | claude -p "You are a git commit message generator. Analyze the provided git diff and generate a single-line Conventional Commits compliant commit message.

CRITICAL REQUIREMENTS:
1. Output ONLY the commit message text - no explanations, no markdown, no quotes, no additional commentary
2. Format: <type>[optional scope]: <description>
3. The entire output must be a valid git commit message that can be used directly with 'git commit -m'

TYPE SELECTION (choose ONE):
- feat: new features or functionality
- fix: bug fixes
- docs: documentation changes only
- style: formatting, whitespace, no code logic changes
- refactor: code restructuring without changing behavior
- perf: performance improvements
- test: adding or modifying tests
- build: build system, dependencies (package.json, Cargo.toml, etc)
- ci: CI/CD configuration (GitHub Actions, CircleCI, etc)
- chore: maintenance tasks, tooling, configs

FORMATTING RULES:
- Description: imperative mood (\"add\" not \"added\"), lowercase, no period at end
- Length: keep total message under 72 characters
- Scope: add if changes focus on specific component (e.g., \"api\", \"ui\", \"auth\")
- Examples:
  * feat(auth): add JWT token validation
  * fix: resolve memory leak in worker threads
  * docs: update installation guide
  * refactor(parser): simplify token handling logic

IMPORTANT: Your entire response must be the commit message only. Any extra text will break the script." --model opus --max-turns 3 --strict-mcp-config)
        if [[ -z "$commit_msg" ]]; then
          echo "Error: Failed to generate commit message"
          return 1
        fi
        ;;
      [Ss])
        git diff --staged | ${PAGER:-less}
        ;;
      [Qq])
        echo "❌ Commit cancelled"
        return 1
        ;;
      *)
        echo "Please choose: Y / e / r / s / q"
        ;;
    esac
  done
}

# Aliases
alias ccmi='claude_commit_interactive'
